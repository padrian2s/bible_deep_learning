<section class="page-section" id="page-648">
    <div class="page-header">
        <div class="page-number">648</div>
        <div class="page-title">
            <h3>Inference as Optimization</h3>
            <span>Capitolul 19 - Sectiunea 19.1</span>
        </div>
    </div>
    <div class="image-container">
        <img src="book_page_jpg/page-648.jpg"
             alt="Pagina 648" class="page-image" onclick="zoomImage(this)">
    </div>
    <div class="explanation-content">
        <div class="interactive-paragraph">
            <div class="paragraph-main" onclick="toggleParagraph(this)">
                <h4>19.1 Inference as Optimization</h4>
                <p>Inferenta exacta poate fi reformulata ca <strong>problema de optimizare</strong>. In loc sa calculam direct log p(v;Î¸), calculam un <strong>lower bound</strong> numit <strong>ELBO</strong> (Evidence Lower BOund) sau <strong>variational free energy negativa</strong>. Aceasta idee fundamentala sta la baza VAE-urilor moderne.</p>
            </div>
            <div class="expandable-sections">
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon simulation">ðŸŽ®</div>
                        <span>Simulare: ELBO in PyTorch</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div class="formula" style="background: var(--bg-dark); padding: 15px; border-radius: 8px;">
                                <p><strong>Evidence Lower Bound:</strong></p>
                                <p style="font-size: 1.1rem; text-align: center; margin: 15px 0;">L(v, Î¸, q) = log p(v;Î¸) - D_KL(q(h|v) || p(h|v;Î¸))</p>
                                <p style="margin-top: 10px;">Unde q este o distributie <strong>aproximativa</strong> arbitrara peste h.</p>
                            </div>
                            <div class="code-block" style="margin-top: 15px;">
                                <pre style="color: var(--text-secondary); font-size: 0.85rem;">
import torch
import torch.nn as nn
import torch.distributions as dist

class ELBOComputation(nn.Module):
    """Demonstreaza calculul ELBO pentru un VAE simplu"""

    def __init__(self, input_dim=784, latent_dim=20):
        super().__init__()
        self.encoder_mu = nn.Linear(input_dim, latent_dim)
        self.encoder_logvar = nn.Linear(input_dim, latent_dim)
        self.decoder = nn.Linear(latent_dim, input_dim)

    def encode(self, x):
        mu = self.encoder_mu(x)
        logvar = self.encoder_logvar(x)
        return mu, logvar

    def reparameterize(self, mu, logvar):
        std = torch.exp(0.5 * logvar)
        eps = torch.randn_like(std)
        return mu + eps * std

    def decode(self, z):
        return torch.sigmoid(self.decoder(z))

    def compute_elbo(self, x):
        mu, logvar = self.encode(x)
        z = self.reparameterize(mu, logvar)
        x_recon = self.decode(z)

        recon_loss = nn.functional.binary_cross_entropy(
            x_recon, x, reduction='sum')

        kl_div = -0.5 * torch.sum(1 + logvar - mu.pow(2) - logvar.exp())

        elbo = -recon_loss - kl_div
        return elbo, recon_loss, kl_div

model = ELBOComputation()
x = torch.rand(32, 784)
elbo, recon, kl = model.compute_elbo(x)
print(f"ELBO: {elbo.item():.2f}")
print(f"Reconstruction: -{recon.item():.2f}")
print(f"KL Divergence: -{kl.item():.2f}")
print(f"\nELBO = E_q[log p(x|z)] - KL(q(z|x) || p(z))")
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon animation">âœ¨</div>
                        <span>Vizualizare: Descompunerea ELBO</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div class="formula" style="font-size: 1.2rem; color: var(--primary);">log p(v) = L(v,Î¸,q) + D_KL(q||p)</div>
                                    <p style="color: var(--text-secondary); margin-top: 10px;">Log-likelihood = ELBO + KL gap</p>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center;">
                                    <div style="background: var(--primary); padding: 15px; border-radius: 8px; text-align: center; opacity: 0.9;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">log p(v)</div>
                                        <div style="font-size: 0.85rem;">Evidence (constant)</div>
                                    </div>
                                    <div style="font-size: 1.5rem;">=</div>
                                    <div style="display: flex; gap: 5px;">
                                        <div style="background: var(--success); padding: 15px; border-radius: 8px; text-align: center; flex: 1;">
                                            <div style="font-weight: bold; margin-bottom: 5px;">L (ELBO)</div>
                                            <div style="font-size: 0.85rem;">Lower bound</div>
                                        </div>
                                        <div style="padding: 15px; display: flex; align-items: center;">+</div>
                                        <div style="background: var(--warning); padding: 15px; border-radius: 8px; text-align: center; flex: 1;">
                                            <div style="font-weight: bold; margin-bottom: 5px;">D_KL</div>
                                            <div style="font-size: 0.85rem;">Gap (â‰¥0)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="key-concept" style="margin-top: 15px;">
                                <h5>Proprietati Cheie:</h5>
                                <ul style="margin-left: 20px;">
                                    <li>KL divergence â‰¥ 0, deci <strong>L â‰¤ log p(v)</strong> mereu</li>
                                    <li>Cand q = p(h|v), KL = 0 si <strong>L = log p(v)</strong> exact</li>
                                    <li>Maximizand L, facem simultan inferenta si learning</li>
                                    <li>q mai bun â†’ L mai strans â†’ gradient mai precis</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon reference">ðŸ“š</div>
                        <span>Forme Alternative ale ELBO</span>
                        <span class="arrow">â–¶</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div class="formula" style="background: var(--bg-dark); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>Forma 1 (KL):</strong></p>
                                <p style="text-align: center; margin: 10px 0;">L = log p(v;Î¸) - D_KL(q(h|v) || p(h|v;Î¸))</p>
                            </div>
                            <div class="formula" style="background: var(--bg-dark); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>Forma 2 (Entropy):</strong></p>
                                <p style="text-align: center; margin: 10px 0;">L = E_q[log p(h,v)] + H(q)</p>
                                <p style="font-size: 0.85rem; color: var(--text-secondary);">Mai usoara pentru calcul - nu necesita p(h|v)!</p>
                            </div>
                            <div class="formula" style="background: var(--bg-dark); padding: 15px; border-radius: 8px;">
                                <p><strong>Forma 3 (VAE style):</strong></p>
                                <p style="text-align: center; margin: 10px 0;">L = E_q[log p(v|h)] - D_KL(q(h|v) || p(h))</p>
                                <p style="font-size: 0.85rem; color: var(--text-secondary);">Reconstruction - KL regularization</p>
                            </div>
                            <div class="reference-item" style="background: var(--bg-lighter); padding: 12px; border-radius: 8px; margin-top: 15px;">
                                <strong style="color: var(--accent);">Importanta istorica:</strong>
                                <p style="font-size: 0.85rem; margin-top: 5px;">ELBO a fost folosit in statistica Bayesiana mult inainte de deep learning. VAE (2014) l-a popularizat pentru retele neuronale, combinandu-l cu reparametrization trick.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
