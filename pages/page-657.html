<section class="page-section" id="page-657">
    <div class="page-header">
        <div class="page-number">657</div>
        <div class="page-title">
            <h3>Derivare ELBO pentru Binary Sparse Coding</h3>
            <span>Capitolul 19 - Sectiunea 19.4.1 (continuare)</span>
        </div>
    </div>
    <div class="image-container">
        <img src="book_page_jpg/page-657.jpg"
             alt="Pagina 657" class="page-image" onclick="zoomImage(this)">
    </div>
    <div class="explanation-content">
        <div class="interactive-paragraph">
            <div class="paragraph-main" onclick="toggleParagraph(this)">
                <h4>ELBO pentru Binary Sparse Coding</h4>
                <p>Derivam explicit ELBO pentru modelul binary sparse coding. Desi formulele arata complex, rezultatul final este <strong>tractabil</strong> - fiecare termen poate fi calculat in timp liniar datorita factorizarii mean field. Aceasta derivare e fundamentul matematic al variational inference.</p>
            </div>
            <div class="expandable-sections">
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon simulation">üéÆ</div>
                        <span>Simulare: ELBO Detaliat</span>
                        <span class="arrow">‚ñ∂</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div class="formula" style="background: var(--bg-dark); padding: 15px; border-radius: 8px;">
                                <p style="text-align: center; font-size: 1.1rem; margin-bottom: 15px;"><strong>L = E_q[log p(h)] + E_q[log p(v|h)] + H(q)</strong></p>
                                <div style="display: grid; gap: 15px; margin-top: 15px;">
                                    <div style="background: var(--bg-lighter); padding: 12px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                        <p><strong style="color: var(--primary);">Termen 1 - Prior:</strong></p>
                                        <p style="font-size: 0.9rem; margin-top: 5px;">E_q[log p(h)] = Œ£·µ¢ [h_hat_i log œÉ(b·µ¢) + (1-h_hat_i) log œÉ(-b·µ¢)]</p>
                                    </div>
                                    <div style="background: var(--bg-lighter); padding: 12px; border-radius: 8px; border-left: 4px solid var(--secondary);">
                                        <p><strong style="color: var(--secondary);">Termen 2 - Likelihood:</strong></p>
                                        <p style="font-size: 0.9rem; margin-top: 5px;">E_q[log p(v|h)] = -Œ≤/2 E_q[||v - Wh||¬≤] + const</p>
                                        <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">Necesita E_q[h] si E_q[hh^T]</p>
                                    </div>
                                    <div style="background: var(--bg-lighter); padding: 12px; border-radius: 8px; border-left: 4px solid var(--accent);">
                                        <p><strong style="color: var(--accent);">Termen 3 - Entropy:</strong></p>
                                        <p style="font-size: 0.9rem; margin-top: 5px;">H(q) = -Œ£·µ¢ [h_hat_i log h_hat_i + (1-h_hat_i) log(1-h_hat_i)]</p>
                                    </div>
                                </div>
                            </div>
                            <div class="code-block" style="margin-top: 15px;">
                                <pre style="color: var(--text-secondary); font-size: 0.85rem;">
import torch

def compute_elbo_detailed(v, h_hat, W, b, beta):
    """Calculeaza ELBO cu toate componentele explicite"""

    prior_term = (h_hat * torch.log(torch.sigmoid(b) + 1e-8) +
                 (1-h_hat) * torch.log(torch.sigmoid(-b) + 1e-8)).sum(dim=1)

    E_h = h_hat
    E_hh_diag = h_hat
    E_hh_offdiag = torch.einsum('bi,bj->bij', h_hat, h_hat)

    recon_mean = E_h @ W.T
    E_recon_sq = (v ** 2).sum(dim=1)
    E_recon_sq -= 2 * (v * recon_mean).sum(dim=1)

    WtW = W.T @ W
    for i in range(h_hat.shape[1]):
        E_recon_sq += E_hh_diag[:, i] * WtW[i, i]
        for j in range(i+1, h_hat.shape[1]):
            E_recon_sq += 2 * E_hh_offdiag[:, i, j] * WtW[i, j]

    likelihood_term = -0.5 * beta * E_recon_sq

    entropy_term = -(h_hat * torch.log(h_hat + 1e-8) +
                    (1-h_hat) * torch.log(1-h_hat + 1e-8)).sum(dim=1)

    elbo = prior_term + likelihood_term + entropy_term

    print(f"Prior term:      {prior_term.mean():.2f}")
    print(f"Likelihood term: {likelihood_term.mean():.2f}")
    print(f"Entropy term:    {entropy_term.mean():.2f}")
    print(f"ELBO total:      {elbo.mean():.2f}")

    return elbo.mean()

W = torch.randn(64, 100) * 0.1
b = torch.zeros(100) - 2.0
beta = 1.0
v = torch.randn(16, 64)
h_hat = torch.sigmoid(b).unsqueeze(0).expand(16, -1)

elbo = compute_elbo_detailed(v, h_hat, W, b, beta)
                                </pre>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon animation">‚ú®</div>
                        <span>Vizualizare: Tractabilitate Mean Field</span>
                        <span class="arrow">‚ñ∂</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div style="background: var(--bg-dark); padding: 20px; border-radius: 12px;">
                                <div style="text-align: center; margin-bottom: 20px;">
                                    <div class="formula" style="color: var(--success); font-size: 1.1rem;">De Ce e Tractabil?</div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div style="background: var(--bg-lighter); padding: 15px; border-radius: 8px;">
                                        <div style="font-weight: bold; color: var(--primary); margin-bottom: 10px;">Fara Mean Field</div>
                                        <p style="font-size: 0.85rem;">E_p(h|v)[f(h)] = Œ£_h p(h|v) f(h)</p>
                                        <p style="font-size: 0.8rem; color: var(--warning); margin-top: 5px;">2^m termeni!</p>
                                    </div>
                                    <div style="background: var(--bg-lighter); padding: 15px; border-radius: 8px;">
                                        <div style="font-weight: bold; color: var(--success); margin-bottom: 10px;">Cu Mean Field</div>
                                        <p style="font-size: 0.85rem;">E_q[h·µ¢] = h_hat_i</p>
                                        <p style="font-size: 0.85rem;">E_q[h·µ¢h‚±º] = h_hat_i * h_hat_j (i‚â†j)</p>
                                        <p style="font-size: 0.8rem; color: var(--success); margin-top: 5px;">O(m¬≤) operatii!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="key-concept" style="margin-top: 15px;">
                                <h5>Cheia Tractabilitatii:</h5>
                                <ul style="margin-left: 20px;">
                                    <li>Mean field: q(h) = ‚àè·µ¢ q(h·µ¢) factorizeaza</li>
                                    <li>Expectatiile se descompun: E_q[h·µ¢h‚±º] = E_q[h·µ¢]E_q[h‚±º] pentru i‚â†j</li>
                                    <li>E_q[h·µ¢] = h_hat_i - probabilitatea ca h·µ¢=1</li>
                                    <li>Fiecare termen calculabil in O(nm) - timpul unui produs matrice-vector</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="section-tab">
                    <div class="section-header" onclick="toggleSection(this)">
                        <div class="section-icon reference">üìö</div>
                        <span>Conexiune cu VAE Modern</span>
                        <span class="arrow">‚ñ∂</span>
                    </div>
                    <div class="section-content">
                        <div class="section-body">
                            <div class="reference-list">
                                <div class="reference-item" style="background: var(--bg-dark); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <strong style="color: var(--primary);">ELBO in VAE</strong>
                                    <div class="formula" style="margin-top: 10px; font-size: 0.9rem;">L = E_q[log p(x|z)] - D_KL(q(z|x) || p(z))</div>
                                    <p style="font-size: 0.85rem; margin-top: 5px;">Aceeasi structura! Reconstruction - KL regularization</p>
                                </div>
                                <div class="reference-item" style="background: var(--bg-dark); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                    <strong style="color: var(--secondary);">Reparametrization Trick</strong>
                                    <p style="font-size: 0.85rem; margin-top: 5px;">VAE foloseste z = Œº + œÉŒµ cu Œµ ~ N(0,1) pentru a permite backprop. Analog cu mean field, dar pentru latente continue.</p>
                                </div>
                                <div class="reference-item" style="background: var(--bg-dark); padding: 12px; border-radius: 8px;">
                                    <strong style="color: var(--accent);">Beta-VAE</strong>
                                    <p style="font-size: 0.85rem; margin-top: 5px;">Multiplica KL term cu Œ≤ pentru a controla trade-off reconstruction vs disentanglement. Direct analog cu Œ≤ in modelul nostru!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
